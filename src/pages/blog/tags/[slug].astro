---
import Layout from '../../../layouts/Page.astro';
import { generateTagData } from '../../../utils/helpers.js';
import { parse } from 'date-fns';

export async function getStaticPaths() {
  const allPosts = await Astro.glob('../posts/*.mdx');
  const sortedPosts = allPosts.sort((a, b) => {
    const dateA = parse(a.frontmatter.publishDate, 'MMM d, yyyy', new Date());
    const dateB = parse(b.frontmatter.publishDate, 'MMM d, yyyy', new Date());
    return dateB.valueOf() - dateA.valueOf();
  });

  const allCategoriesUnique = new Set<string>();

  sortedPosts.forEach(post => {
    if (post.frontmatter.tags && Array.isArray(post.frontmatter.tags)) {
      post.frontmatter.tags.forEach((tag: string) => {
        allCategoriesUnique.add(tag);
      });
    }
  });

  const allCategoriesData = generateTagData(allCategoriesUnique);

  return allCategoriesData.map((tag) => {
    const posts = sortedPosts.filter((post) =>
      post.frontmatter.tags && post.frontmatter.tags.includes(tag.title)
    );
    return {
      params: { slug: tag.slug },
      props: {
        tag: tag.title,
        posts: posts,
      },
    };
  });
}

const { tag, posts } = Astro.props;

const seo = {
  title: `${tag} | Blog`,
  description: `Articles tagged with ${tag}`,
};

const formatDate = (dateStr: string) => {
  try {
    const date = parse(dateStr, 'MMM d, yyyy', new Date());
    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }).format(date);
  } catch {
    return dateStr;
  }
};
---

<Layout seo={seo}>
  <div class="tag-page-container">
    <header class="tag-page-header">
      <h1 class="tag-page-title">
        <span class="tag-page-label">Posts tagged</span>
        "{tag}"
      </h1>
      <p class="tag-page-count">{posts.length} {posts.length === 1 ? 'article' : 'articles'}</p>

      <!-- Navigation -->
      <nav class="tag-page-nav">
        <a href="/blog/categories" class="tag-page-nav__link">Categories</a>
        <a href="/blog/tags" class="tag-page-nav__link tag-page-nav__link--active">Tags</a>
        <a href="/blog/authors" class="tag-page-nav__link">Authors</a>
      </nav>
    </header>

    <hr class="tag-page-separator" />

    <section class="tag-page-posts">
      {posts.map((post: any) => (
        <article class="tag-post-card">
          {post.frontmatter.featuredImage && (
            <a href={post.url} class="tag-post-card__image-link">
              <img
                src={post.frontmatter.featuredImage}
                alt={post.frontmatter.title}
                class="tag-post-card__image"
              />
            </a>
          )}
          <div class="tag-post-card__content">
            <span class="tag-post-card__date">{formatDate(post.frontmatter.publishDate)}</span>
            <h2 class="tag-post-card__title">
              <a href={post.url}>{post.frontmatter.title}</a>
            </h2>
            {post.frontmatter.excerpt && (
              <p class="tag-post-card__excerpt">{post.frontmatter.excerpt}</p>
            )}
            <a href={post.url} class="tag-post-card__read-more">Read More →</a>
          </div>
        </article>
      ))}
    </section>

    {posts.length === 0 && (
      <p class="tag-page-empty">No articles found with this tag.</p>
    )}

    <div class="tag-page-back">
      <a href="/blog" class="tag-page-back__link">← Back to Blog</a>
    </div>
  </div>
</Layout>

<style>
  .tag-page-container {
    max-width: var(--container-max-width-narrow, 960px);
    margin: 0 auto;
    padding: 2rem 1rem 4rem;
    min-height: 60vh;
  }

  .tag-page-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .tag-page-title {
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--theme-on-bg);
    margin-bottom: 0.5rem;
  }

  .tag-page-label {
    font-weight: 400;
    color: var(--theme-on-bg);
    opacity: 0.7;
  }

  .tag-page-count {
    color: var(--theme-on-bg);
    opacity: 0.7;
    font-size: 0.9375rem;
    margin-bottom: 1.25rem;
  }

  /* Navigation */
  .tag-page-nav {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
  }

  .tag-page-nav__link {
    display: inline-block;
    color: var(--theme-on-bg);
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: var(--theme-button-border-radius, 0.5rem);
    transition: all var(--theme-transition);
  }

  .tag-page-nav__link:hover {
    background-color: var(--theme-surface-1);
    color: var(--theme-on-surface-1);
  }

  .tag-page-nav__link--active {
    background-color: var(--theme-primary);
    color: var(--theme-on-primary, #ffffff);
  }

  .tag-page-nav__link--active:hover {
    background-color: var(--theme-primary-hover);
    color: var(--theme-on-primary, #ffffff);
  }

  .tag-page-separator {
    border: none;
    border-top: 1px solid var(--theme-surface-1);
    margin: 2rem 0;
  }

  .tag-page-posts {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Post Card - Horizontal Layout */
  .tag-post-card {
    display: flex;
    gap: 1.5rem;
    background: var(--theme-bg);
    border: 1px solid var(--theme-surface-1);
    border-radius: var(--theme-shape-radius);
    overflow: hidden;
    transition: box-shadow var(--theme-transition);
  }

  .tag-post-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .tag-post-card__image-link {
    flex-shrink: 0;
    width: 200px;
  }

  .tag-post-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    min-height: 150px;
  }

  .tag-post-card__content {
    flex: 1;
    padding: 1.25rem 1.25rem 1.25rem 0;
    display: flex;
    flex-direction: column;
  }

  .tag-post-card__date {
    font-size: 0.8125rem;
    color: var(--theme-on-bg);
    opacity: 0.6;
    margin-bottom: 0.5rem;
  }

  .tag-post-card__title {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 0.5rem;
  }

  .tag-post-card__title a {
    color: var(--theme-on-bg);
    text-decoration: none;
  }

  .tag-post-card__title a:hover {
    color: var(--theme-primary);
  }

  .tag-post-card__excerpt {
    color: var(--theme-on-bg);
    opacity: 0.7;
    font-size: 0.9375rem;
    line-height: 1.5;
    margin-bottom: 0.75rem;
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tag-post-card__read-more {
    color: var(--theme-primary);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
  }

  .tag-post-card__read-more:hover {
    color: var(--theme-primary-hover);
    text-decoration: underline;
  }

  .tag-page-empty {
    text-align: center;
    color: var(--theme-on-bg);
    opacity: 0.7;
    font-size: 1rem;
    margin-top: 2rem;
  }

  .tag-page-back {
    text-align: center;
    margin-top: 3rem;
  }

  .tag-page-back__link {
    color: var(--theme-on-bg);
    opacity: 0.7;
    text-decoration: none;
    font-size: 0.875rem;
  }

  .tag-page-back__link:hover {
    color: var(--theme-primary);
    opacity: 1;
  }

  @media (max-width: 640px) {
    .tag-page-container {
      padding: 1rem 1rem 3rem;
    }

    .tag-post-card {
      flex-direction: column;
    }

    .tag-post-card__image-link {
      width: 100%;
    }

    .tag-post-card__image {
      height: 180px;
    }

    .tag-post-card__content {
      padding: 1rem;
    }

    .tag-page-nav {
      gap: 0.75rem;
    }

    .tag-page-nav__link {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }
  }
</style>
