---
import Layout from '../../../layouts/Page.astro';
import { parse } from 'date-fns';

export async function getStaticPaths() {
  const allPosts = await Astro.glob('../posts/*.mdx');
  const sortedPosts = allPosts.sort((a, b) => {
    const dateA = parse(a.frontmatter.publishDate, 'MMM d, yyyy', new Date());
    const dateB = parse(b.frontmatter.publishDate, 'MMM d, yyyy', new Date());
    return dateB.valueOf() - dateA.valueOf();
  });

  const authorsUnique = new Set<string>();

  sortedPosts.forEach(post => {
    if (post.frontmatter.author) {
      authorsUnique.add(post.frontmatter.author);
    }
  });

  return Array.from(authorsUnique).map((author) => {
    const posts = sortedPosts.filter((post) => post.frontmatter.author === author);
    return {
      params: { slug: author.toLowerCase().replace(/\s+/g, '-') },
      props: {
        author,
        posts,
      },
    };
  });
}

const { author, posts } = Astro.props;

const seo = {
  title: `${author} | Blog`,
  description: `Articles by ${author}`,
};

const formatDate = (dateStr: string) => {
  try {
    const date = parse(dateStr, 'MMM d, yyyy', new Date());
    return new Intl.DateTimeFormat('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }).format(date);
  } catch {
    return dateStr;
  }
};
---

<Layout seo={seo}>
  <div class="author-page-container">
    <header class="author-page-header">
      <div class="author-page-avatar">
        {author.charAt(0).toUpperCase()}
      </div>
      <h1 class="author-page-title">{author}</h1>
      <p class="author-page-count">{posts.length} {posts.length === 1 ? 'article' : 'articles'}</p>

      <!-- Navigation -->
      <nav class="author-page-nav">
        <a href="/blog/categories" class="author-page-nav__link">Categories</a>
        <a href="/blog/tags" class="author-page-nav__link">Tags</a>
        <a href="/blog/authors" class="author-page-nav__link author-page-nav__link--active">Authors</a>
      </nav>
    </header>

    <hr class="author-page-separator" />

    <section class="author-page-posts">
      {posts.map((post: any) => (
        <article class="author-post-card">
          {post.frontmatter.featuredImage && (
            <a href={post.url} class="author-post-card__image-link">
              <img
                src={post.frontmatter.featuredImage}
                alt={post.frontmatter.title}
                class="author-post-card__image"
              />
            </a>
          )}
          <div class="author-post-card__content">
            <div class="author-post-card__meta">
              <span class="author-post-card__date">{formatDate(post.frontmatter.publishDate)}</span>
              {post.frontmatter.category && (
                <a
                  href={`/blog/categories/${post.frontmatter.category.toLowerCase().replace(/\s+/g, '-')}`}
                  class="author-post-card__category"
                >
                  {post.frontmatter.category}
                </a>
              )}
            </div>
            <h2 class="author-post-card__title">
              <a href={post.url}>{post.frontmatter.title}</a>
            </h2>
            {post.frontmatter.excerpt && (
              <p class="author-post-card__excerpt">{post.frontmatter.excerpt}</p>
            )}
            <a href={post.url} class="author-post-card__read-more">Read More →</a>
          </div>
        </article>
      ))}
    </section>

    {posts.length === 0 && (
      <p class="author-page-empty">No articles found by this author.</p>
    )}

    <div class="author-page-back">
      <a href="/blog" class="author-page-back__link">← Back to Blog</a>
    </div>
  </div>
</Layout>

<style>
  .author-page-container {
    max-width: var(--container-max-width-narrow, 960px);
    margin: 0 auto;
    padding: 2rem 1rem 4rem;
    min-height: 60vh;
  }

  .author-page-header {
    text-align: center;
    margin-bottom: 1.5rem;
  }

  .author-page-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background-color: var(--theme-primary);
    color: var(--theme-on-primary, #ffffff);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 auto 1rem;
  }

  .author-page-title {
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    color: var(--theme-on-bg);
    margin-bottom: 0.5rem;
  }

  .author-page-count {
    color: var(--theme-on-bg);
    opacity: 0.7;
    font-size: 0.9375rem;
    margin-bottom: 1.25rem;
  }

  /* Navigation */
  .author-page-nav {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
  }

  .author-page-nav__link {
    display: inline-block;
    color: var(--theme-on-bg);
    text-decoration: none;
    font-size: 0.9375rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: var(--theme-button-border-radius, 0.5rem);
    transition: all var(--theme-transition);
  }

  .author-page-nav__link:hover {
    background-color: var(--theme-surface-1);
    color: var(--theme-on-surface-1);
  }

  .author-page-nav__link--active {
    background-color: var(--theme-primary);
    color: var(--theme-on-primary, #ffffff);
  }

  .author-page-nav__link--active:hover {
    background-color: var(--theme-primary-hover);
    color: var(--theme-on-primary, #ffffff);
  }

  .author-page-separator {
    border: none;
    border-top: 1px solid var(--theme-surface-1);
    margin: 2rem 0;
  }

  .author-page-posts {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* Post Card - Horizontal Layout */
  .author-post-card {
    display: flex;
    gap: 1.5rem;
    background: var(--theme-bg);
    border: 1px solid var(--theme-surface-1);
    border-radius: var(--theme-shape-radius);
    overflow: hidden;
    transition: box-shadow var(--theme-transition);
  }

  .author-post-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }

  .author-post-card__image-link {
    flex-shrink: 0;
    width: 200px;
  }

  .author-post-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    min-height: 150px;
  }

  .author-post-card__content {
    flex: 1;
    padding: 1.25rem 1.25rem 1.25rem 0;
    display: flex;
    flex-direction: column;
  }

  .author-post-card__meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
  }

  .author-post-card__date {
    font-size: 0.8125rem;
    color: var(--theme-on-bg);
    opacity: 0.6;
  }

  .author-post-card__category {
    font-size: 0.75rem;
    color: var(--theme-on-surface-1);
    background-color: var(--theme-surface-1);
    padding: 0.125rem 0.5rem;
    border-radius: 0.25rem;
    text-decoration: none;
  }

  .author-post-card__category:hover {
    background-color: var(--theme-surface-2);
  }

  .author-post-card__title {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.3;
    margin-bottom: 0.5rem;
  }

  .author-post-card__title a {
    color: var(--theme-on-bg);
    text-decoration: none;
  }

  .author-post-card__title a:hover {
    color: var(--theme-primary);
  }

  .author-post-card__excerpt {
    color: var(--theme-on-bg);
    opacity: 0.7;
    font-size: 0.9375rem;
    line-height: 1.5;
    margin-bottom: 0.75rem;
    flex: 1;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .author-post-card__read-more {
    color: var(--theme-primary);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
  }

  .author-post-card__read-more:hover {
    color: var(--theme-primary-hover);
    text-decoration: underline;
  }

  .author-page-empty {
    text-align: center;
    color: var(--theme-on-bg);
    opacity: 0.7;
    font-size: 1rem;
    margin-top: 2rem;
  }

  .author-page-back {
    text-align: center;
    margin-top: 3rem;
  }

  .author-page-back__link {
    color: var(--theme-on-bg);
    opacity: 0.7;
    text-decoration: none;
    font-size: 0.875rem;
  }

  .author-page-back__link:hover {
    color: var(--theme-primary);
    opacity: 1;
  }

  @media (max-width: 640px) {
    .author-page-container {
      padding: 1rem 1rem 3rem;
    }

    .author-post-card {
      flex-direction: column;
    }

    .author-post-card__image-link {
      width: 100%;
    }

    .author-post-card__image {
      height: 180px;
    }

    .author-post-card__content {
      padding: 1rem;
    }

    .author-page-nav {
      gap: 0.75rem;
    }

    .author-page-nav__link {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
    }
  }
</style>
